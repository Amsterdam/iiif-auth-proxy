x-common-depends-on: &common-depends-on
  migrate:
    condition: service_completed_successfully
  azurite:
    condition: service_healthy

x-common-env: &common-env
  LOG_LEVEL: "WARNING"
  DJANGO_LOG_LEVEL: "WARNING"
  SECRET_KEY: "insecure"
  JWT_SECRET_KEY: "insecure"
  DATABASE_HOST: "iiif-auth-proxy-database"
  AZURITE_STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://iiif-auth-proxy-azurite:10000/devstoreaccount1;"
  AZURITE_QUEUE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;QueueEndpoint=http://iiif-auth-proxy-azurite:10001/devstoreaccount1;"
  OTEL_SERVICE_NAME: "iiif-auth-proxy"
  OTEL_TRACES_SAMPLER: "always_on"
  OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
  OTEL_INSTRUMENTATION_HTTP_CAPTURE_HEADERS_SERVER_REQUEST: ".*"
  OTEL_INSTRUMENTATION_HTTP_CAPTURE_HEADERS_SERVER_RESPONSE: ".*"
  OTEL_EXPORTER_OTLP_ENDPOINT: http://iiif-auth-proxy-otel-collector:4317

x-app: &base-app
  build:
    context: .
    target: app
  depends_on:
    <<: *common-depends-on
  volumes:
    - .:/app/
  networks:
    - amsterdam-bouwdossiers
    - default

volumes:
  azurite_data:
  db_data:

services:
  database:
    container_name: iiif-auth-proxy-database
    image: postgres:15
    environment:
      POSTGRES_DB: dev
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: dev
    volumes:
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test: pg_isready -U statistiek_hub -d statistiek_hub
      interval: 10s
      timeout: 1s
      retries: 5

  migrate:
    container_name: iiif-auth-proxy-migrate
    build:
      context: .
      target: app
    environment:
      SECRET_KEY: "insecure"
      DJANGO_SETTINGS_MODULE: main.settings
      OTEL_SDK_DISABLED: true
    depends_on:
      database:
        condition: service_healthy
    volumes:
      - .:/app
    user: 1000:1000
    command: python manage.py migrate --noinput
    restart: "no"
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512mb
        reservations:
          cpus: "0.25"
          memory: 256M
  
  azurite:
    container_name: iiif-auth-proxy-azurite
    image: mcr.microsoft.com/azure-storage/azurite:latest
    ports:
      - "10000:10000"  # Blob service
      - "10001:10001"  # Queue service
    volumes:
      - azurite_data:/data
    command: >
      azurite
      -l /data
      --blobHost 0.0.0.0
      --queueHost 0.0.0.0
      --loose
    healthcheck:
      test: nc 127.0.0.1 10000 -z
      interval: 1s
      retries: 30

  app:
    container_name: iiif-auth-proxy-app
    <<: *base-app
    build:
      context: .
      target: app
    image: ${REGISTRY:-localhost:5000}/${REPOSITORY:-opdrachten/iiif-auth-proxy}:${VERSION:-latest}
    ports:
      - "8000:8000"
    environment:
      <<: *common-env
    depends_on:
      <<: *common-depends-on
      otel-collector:
        condition: service_started
    command: /app/deploy/docker-run.sh
    user: 1000:1000

  dev:
    container_name: iiif-auth-proxy-dev
    <<: *base-app
    build:
      context: .
      target: dev
    ports:
      - "8001:8000"
    environment:
      <<: *common-env
      LOG_LEVEL: "DEBUG"
      DJANGO_LOG_LEVEL: "DEBUG"
      DEBUG: "true"
      USE_JWKS_TEST_KEY: "true"
      METADATA_SERVER_BASE_URL: "http://metadata-server:8000"
    depends_on:
      <<: *common-depends-on
      otel-collector:
        condition: service_started
    command: python manage.py runserver 0.0.0.0:8000
    user: 1000:1000

  test:
    container_name: iiif-auth-proxy-test
    <<: *base-app
    build:
      context: .
      target: tests
    environment:
      <<: *common-env
      LOG_LEVEL: "DEBUG"
      DJANGO_LOG_LEVEL: "DEBUG"      
      DJANGO_SETTINGS_MODULE: "main.settings"
      USE_JWKS_TEST_KEY: "true"
      OTEL_SDK_DISABLED: true
      EMAIL_HOST_USER: "test"
      EMAIL_HOST_PASSWORD: "insecure"
      EMAIL_BACKEND: "django.core.mail.backends.locmem.EmailBackend"
      COVERAGE_FILE: /tmp/.coverage
    user: 1000:1000

  linting:
    container_name: iiif-auth-proxy-linting
    build:
      context: .
      target: linting
    volumes:
      - .:/app/
    user: 1000:1000

  otel-collector:
    container_name: iiif-auth-proxy-otel-collector
    build:
      context: otel-collector
    volumes:
      - ./otel-collector/config.local.yaml:/etc/otelcol-contrib/config.yaml
    depends_on:
      - jaeger
    ports:
      - "4317:4317"
    deploy:
      resources:
        limits:
          cpus: "0.1"
          memory: 256M
        reservations:
          cpus: "0.05"
          memory: 128M

  jaeger:
    container_name: iiif-auth-proxy-jaeger
    image: jaegertracing/jaeger:2.8.0
    ports:
      # ui
      - "16686:16686"
      # grpc
      - "14317:4317"
    environment:
      LOG_LEVEL: debug

networks:
  amsterdam-bouwdossiers:
    name: amsterdam-bouwdossiers
    driver: bridge
